name: mysql
description: runs a mysql container
inputs:
  srcDir:
    dir:
      default: .
  MYSQL_USER:
    string:
      default: testuser
  MYSQL_PASSWORD:
    string:
      default: testpassword
  MYSQL_DATABASE:
    string:
      default: testapp
  MYSQL_HOST:
    string:
      default: mysql
  doSeed:
    boolean:
      default: false
run:
  parallel:
    - container:
        image: { ref: 'mysql:8' }
        name: mysql # this value will be provided as input to the 'local' op so our code knows what mysql host to connect to
        envVars: {MYSQL_USER , MYSQL_PASSWORD , MYSQL_DATABASE , MYSQL_RANDOM_ROOT_PASSWORD: "yes"}
        ports: { '3306': '3306' }
    - container:
        image: { ref: 'mysql:8' }
        envVars: {MYSQL_USER, MYSQL_PASSWORD, MYSQL_HOST, MYSQL_DATABASE, doSeed}
        dirs:
          /db: $(srcDir/.opspec/mysql)
        workDir: /db
        cmd: 
          - sh
          - -ce
          - |
            echo "starting seed script"
            sleep 25
            if [ $doSeed = "true" ]
            then
              echo "connecting"
              mysql -u $MYSQL_USER -p$MYSQL_PASSWORD -h $MYSQL_HOST $MYSQL_DATABASE < /db/seed.sql
            fi
            exit 0