name: debug
description: runs go-svc for debugging
inputs:
  srcDir:
    dir:
      default: ./
  MYSQL_USER:
    string:
      default: testuser
  MYSQL_PASSWORD:
    string:
      default: testpassword
  MYSQL_DATABASE:
    string:
      default: testapp
  MYSQL_HOST:
    string:
      default: mysql # the host for mysql will have the container name in the mysql op
run:
  parallel:
    - op:
        ref: ../mysql
        inputs: { srcDir, MYSQL_USER, MYSQL_PASSWORD, MYSQL_HOST, MYSQL_DATABASE, doSeed: true}
    - container:
        image: { ref: 'golang:1.10.3' }
        name: go-svc
        dirs:
          /go/src: $(srcDir/src)
          /go/pkg: $(srcDir/pkg)
          /go/bin: $(srcDir/bin)
          /go/src/go-srv: $(srcDir/app)
        envVars: {MYSQL_USER, MYSQL_PASSWORD, MYSQL_HOST, MYSQL_DATABASE}
        workDir: /go/src/go-srv
        ports: { '8080': '8080' }
        cmd:
          - sh
          - -ce
          - |
            sleep 30
            /go/bin/reflex -g 'main.go' -s -- sh -c 'go run main.go'